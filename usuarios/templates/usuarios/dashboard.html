{% extends "base.html" %}
{% block title %}Dashboard ‚Äî Exchange{% endblock %}
{% block meta_description %}Resumen de tu cartera, saldos y actividad reciente.{% endblock %}

{% block content %}
<div class="relative">
  
  <!-- üîî Bot√≥n Notificaciones -->
  <div id="notificaciones-container" class="absolute top-4 right-4">
    <button onclick="toggleNotificaciones()" class="relative p-2 bg-white border border-gray-200 rounded-full shadow hover:bg-gray-50">
      üîî
      <span id="notificaciones-indicador" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
    </button>

    <div id="notificaciones-box" class="hidden absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-80 overflow-y-auto z-50">
      <ul id="notificaciones-lista" class="divide-y divide-gray-100"></ul>
    </div>
  </div>

  <!-- üíπ Cuadro de Cotizaciones fijo -->
  <div id="cuadro-cotizaciones" class="fixed top-4 right-20 bg-gray-900 text-white p-4 rounded-xl shadow-lg text-sm min-w-[180px] z-40">
    <h4 class="text-center text-cyan-300 font-semibold mb-2">Cotizaciones</h4>
    <table class="w-full text-xs">
      <tr>
        <td class="font-bold">USDT:</td>
        <td>Compra:</td>
        <td>${{ cot_usdt.compra }}</td>
      </tr>
      <tr>
        <td></td>
        <td>Venta:</td>
        <td>${{ cot_usdt.venta }}</td>
      </tr>
      <tr>
        <td class="font-bold">USD:</td>
        <td>Compra:</td>
        <td>${{ cot_usd.compra }}</td>
      </tr>
      <tr>
        <td></td>
        <td>Venta:</td>
        <td>${{ cot_usd.venta }}</td>
      </tr>
    </table>
  </div>

  <!-- üëã Bienvenida -->
  <h2 class="text-2xl font-semibold mb-6">Bienvenido, {{ request.user.username }}</h2>

  <!-- üìå Saldos -->
  <div class="grid gap-4 sm:grid-cols-3 mb-8">
    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow">
      <p class="text-sm text-gray-500">Saldo ARS</p>
      <p class="text-2xl font-bold">${{ request.user.saldo_ars }}</p>
    </div>
    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow">
      <p class="text-sm text-gray-500">Saldo USDT</p>
      <p class="text-2xl font-bold">{{ request.user.saldo_usdt }}</p>
    </div>
    <div class="bg-white border border-gray-200 rounded-xl p-5 shadow">
      <p class="text-sm text-gray-500">Saldo USD</p>
      <p class="text-2xl font-bold">{{ request.user.saldo_usd|default:"0.00" }}</p>
    </div>
  </div>

  <!-- üîß Acciones r√°pidas -->
  <div class="bg-white border border-gray-200 rounded-xl p-5 shadow mb-8">
    <h3 class="text-lg font-semibold mb-4">Acciones r√°pidas</h3>
    <div class="flex flex-wrap gap-3 text-sm">
      <a href="{% url 'operar' %}" class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">üîÅ Comprar / Vender</a>
      <a href="{% url 'agregar_saldo' %}" class="rounded-md bg-green-600 px-4 py-2 text-white hover:bg-green-700">üí∏ Agregar Saldo</a>
      <a href="{% url 'solicitar_retiro' %}" class="rounded-md bg-yellow-500 px-4 py-2 text-white hover:bg-yellow-600">üí∏ Solicitar Retiro</a>
      <a href="{% url 'exportar_movimientos_usuario' %}" class="rounded-md bg-gray-600 px-4 py-2 text-white hover:bg-gray-700">üì• Exportar movimientos</a>
      <a href="{% url 'logout' %}" class="rounded-md bg-red-600 px-4 py-2 text-white hover:bg-red-700">üö™ Cerrar sesi√≥n</a>
    </div>
  </div>

  <!-- üîî Notificaciones recientes -->
  <div class="bg-white border border-gray-200 rounded-xl p-5 shadow mb-8">
    <h3 class="text-lg font-semibold mb-4">Notificaciones recientes</h3>
    <ul class="divide-y divide-gray-100 text-sm">
      {% for n in notificaciones %}
        <li class="py-2">
          {{ n.fecha|date:"d/m/Y H:i" }} - {{ n.mensaje }}
          {% if not n.leida %} <strong class="text-red-600">(nuevo)</strong> {% endif %}
        </li>
      {% empty %}
        <li class="py-4 text-gray-500">No hay notificaciones.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- üìú Historial de movimientos -->
  <div>
    <h3 class="text-lg font-semibold mb-4">Historial de movimientos</h3>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-200 text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-200 px-3 py-2">Fecha</th>
            <th class="border border-gray-200 px-3 py-2">Tipo</th>
            <th class="border border-gray-200 px-3 py-2">Moneda</th>
            <th class="border border-gray-200 px-3 py-2">Monto</th>
            <th class="border border-gray-200 px-3 py-2">Saldo antes</th>
            <th class="border border-gray-200 px-3 py-2">Saldo despu√©s</th>
            <th class="border border-gray-200 px-3 py-2">Descripci√≥n</th>
            <th class="border border-gray-200 px-3 py-2">ID</th>
          </tr>
        </thead>
        <tbody>
          {% for m in movimientos %}
            <tr class="hover:bg-gray-50">
              <td class="border border-gray-200 px-3 py-2">{{ m.fecha }}</td>
              <td class="border border-gray-200 px-3 py-2">{{ m.get_tipo_display }}</td>
              <td class="border border-gray-200 px-3 py-2">{{ m.moneda }}</td>
              <td class="border border-gray-200 px-3 py-2">${{ m.monto }}</td>
              <td class="border border-gray-200 px-3 py-2">${{ m.saldo_antes }}</td>
              <td class="border border-gray-200 px-3 py-2">${{ m.saldo_despues }}</td>
              <td class="border border-gray-200 px-3 py-2">{{ m.descripcion }}</td>
              <td class="border border-gray-200 px-3 py-2">{{ m.codigo }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="border border-gray-200 px-3 py-4 text-center text-gray-500">Sin movimientos a√∫n.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- üìú Scripts para notificaciones -->
<script>
function toggleNotificaciones() {
  const box = document.getElementById('notificaciones-box');
  box.classList.toggle('hidden');

  if (!box.classList.contains('hidden')) {
    fetch('/notificaciones/ajax/')
      .then(response => response.json())
      .then(data => {
        const lista = document.getElementById('notificaciones-lista');
        lista.innerHTML = '';

        data.notificaciones.forEach(n => {
          const li = document.createElement('li');
          li.className = 'py-2 px-3 hover:bg-gray-50';
          li.textContent = `${n.fecha}: ${n.mensaje}`;
          lista.appendChild(li);
        });

        document.getElementById('notificaciones-indicador').style.display = 'none';
      });
  }
}

function verificarNotificaciones() {
  fetch('/notificaciones/contar/')
    .then(response => response.json())
    .then(data => {
      const indicador = document.getElementById('notificaciones-indicador');
      if (data.no_leidas > 0) {
        indicador.textContent = data.no_leidas > 9 ? '9+' : data.no_leidas;
        indicador.style.display = 'flex';
      } else {
        indicador.style.display = 'none';
      }
    });
}

document.addEventListener('DOMContentLoaded', verificarNotificaciones);
</script>
{% endblock %}
